<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Feed The Sumo</title>
    <!--<script src="js/phaser.min.js"></script>-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/phaser/2.1.0/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script>

// Skapar ett phaser game
var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
var player;
var platforms;
var sumos;
var cursors;
var foodItems;
var score = 0;
var scoreText;
var jumpButton;
var hasFoodItem;

// Tile mapp
var map;
var layer;
var colBox;

function preload () {

    // Laddar tilemap
    game.load.tilemap('test', 'assets/test.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.image('tiles', 'assets/tilesetbasics.png');

    // Laddar objekt
    game.load.image('sky', 'assets/sky.png');
    game.load.image('ground', 'assets/platform.png');
    game.load.image('platform', 'assets/platform_free.png');
    game.load.spritesheet('player', 'assets/dude.png', 32, 48);
    game.load.image('sumoGreen', 'assets/lonleySumo.png');
    game.load.image('food', 'assets/star.png');


}

function create () {

    // Skapar tilemappen
    map = game.add.tilemap('test');

    map.addTilesetImage('tilesetbasics', 'tiles');

    // hmm, how to fix...
    map.setCollisionByExclusion([]);

    layer = map.createLayer('Ground');

    //layer.resizeWorld();
    //layer.debug = true;

    colBox = map.createLayer('platform');

    // Använder arcade physics
    game.physics.startSystem(Phaser.Physics.ARCADE);

/*
    // Skapar bakgrunden
    game.add.sprite(0, 0, 'sky');

    // Skapa en grupp för platform och enable physics
    platforms = game.add.group();
    platforms.enableBody = true;

    // Skapar marken
    var ground = platforms.create(0, game.world.height - 64, 'ground');
    ground.scale.setTo(2, 2);
    ground.body.immovable = true;

    // Skapar platformar
    var platform1 = platforms.create(game.world.width - 200, game.world.height - 200, 'platform');
    platform1.scale.setTo(0.4, 1);
    platform1.body.immovable = true;

    var platform2 = platforms.create(game.world.width - 500, game.world.height - 400, 'platform');
    platform2.scale.setTo(0.4, 1);
    platform2.body.immovable = true;
*/
    // Skapa sumon
    sumos = game.add.group();
    sumos.enableBody = true;
    var sumo = sumos.create(400, game.world.height - 108, 'sumoGreen');

    // Skapar splare
    player = game.add.sprite(300, game.world.height - 180, 'player');
    //game.physics.arcade.enable(player);
    game.physics.enable(player, Phaser.Physics.ARCADE);

    // Spelarens egenskaper
    player.body.bounce.y = 0.2;
    player.body.gravity.y = 200;
    player.collideWorldBounds = true;
    player.body.setSize(20, 32, 5, 16);

    // Spelarens animationer (Bara i början)
    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 7], 10, true);

    // Skapa mat
    foodItems = game.add.group();
    foodItems.enableBody = true;
    //var food = foodItems.create(game.world.width - 500, game.world.height - 430, 'food');
    var food = foodItems.create(100, game.world.height - 150, 'food');

    // Text
    scoreText = game.add.text(16, 16, 'Weight Gain: 0kg', { fontSize: '32px', fill: '#000' });

    // Kontoller
    cursors = game.input.keyboard.createCursorKeys();
    jumpButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);
}

function update () {
/*
    // Kollision mellan objekt
    game.physics.arcade.collide(player, platforms);
    game.physics.arcade.collide(foodItems, platforms);
*/
    //Kollision mellan spelare och layer
    game.physics.arcade.collide(player, layer);

    // Koll om splare tar ett foodItem
    game.physics.arcade.overlap(player, foodItems, collectFood, null, this);

    // Mata sumon
    game.physics.arcade.overlap(player, sumos, feedTheSumo, null, this);

    // Nollställer rörelse
    player.body.velocity.x = 0;

    // Kontroll
    if (cursors.left.isDown)
    {
        //  Vänster
        player.body.velocity.x = -150;

        player.animations.play('left');
    }
    else if (cursors.right.isDown)
    {
        //  Höger
        player.body.velocity.x = 150;

        player.animations.play('right');
    }
    else
    {
        //  Stilla
        player.animations.stop();

        player.frame = 4;
    }
 if (jumpButton.isDown && player.body.onFloor())
    {
        player.body.velocity.y = -250;
        jumpTimer = game.time.now + 750;
    }
    // Hoppa
    if (jumpButton.isDown && player.body.touching.down)
    {
        player.body.velocity.y = -250;
    }

}

function collectFood(player, food)
{
    food.kill();
    hasFoodItem = true;
    console.log('Collected food, , hasFoodItem =' + hasFoodItem);
}

function feedTheSumo(player, sumo)
{
    if(hasFoodItem)
    {
        score += 5;
        scoreText.text = 'Weight Gain: ' + score + 'kg';
        hasFoodItem = false;
        console.log('feed sumo, hasFoodItem = ' + hasFoodItem);
    }
    
}

</script>

</body>
</html>