<!doctype html> 
<html lang="en"> 
<head> 
    <meta charset="UTF-8" />
    <title>Feed The Sumo</title>
    <!--<script src="js/phaser.min.js"></script>-->
    <script src="//cdnjs.cloudflare.com/ajax/libs/phaser/2.1.0/phaser.min.js"></script>
    <style>
        body {
            margin: 0;
        }
    </style>
</head>
<body>

<script>

// Skapar ett phaser game
var game = new Phaser.Game(800, 600, Phaser.AUTO, '', { preload: preload, create: create, update: update });
// karaktärer
var player;
var sumos;
var enemy;
// kontroller
var cursors;
var jumpButton;
// Mat
var foodItems;
var hasFoodItem;
// Text
var score = 0;
var scoreText;
var gameTime = 0;
var gameTimeText;
// Tile mapp
var map;
var layer;
// Time TODO
var curTime;
var startTime;
// Audio
var sound;

// bool
var dropped;


function preload () {

    // Laddar tilemap
    game.load.tilemap('test', 'assets/test.json', null, Phaser.Tilemap.TILED_JSON);
    game.load.image('tiles', 'assets/tilesetbasics.png');

    // Laddar objekts bilder
    //game.load.spritesheet('player', 'assets/dude.png', 32, 48);
    game.load.image('sumoGreen', 'assets/lonleySumo.png');
    game.load.image('food', 'assets/star.png');
    game.load.spritesheet('baddie', 'assets/baddie.png', 32, 32);

    // Laddar ljud
    game.load.audio('dmg', 'assets/sound/TakeDamage7.wav');


}

function create () {
    // Skapar tilemappen
    map = game.add.tilemap('test');
    map.addTilesetImage('tilesetbasics', 'tiles');

    // Kollision med allt
    map.setCollisionByExclusion([]);

    layer = map.createLayer('Ground');
    layer.resizeWorld();
    layer.debug = true;

    // Time TODO
    game.time.advancedTiming = true;
    //startTime = new Phaser.Timer(game);
    //startTime.start();
    //console.log(startTime);

    // Använder arcade physics
    game.physics.startSystem(Phaser.Physics.ARCADE);

    //
    // Skapa sumo(s)
    //
    sumos = game.add.group();
    sumos.enableBody = true;
    createSumo(sumos);

    //
    // Skapa enemy
    //
    createEnemy();
    
    //
    // Skapar spelare
    //
    createPlayer();
    
    //
    // Skapa mat
    //
    foodItems = game.add.group();
    foodItems.enableBody = true;
    //game.physics.enable(foodItems, Phaser.Physics.ARCADE);
    createFoodItem(foodItems, 100, 150, false);

    //
    // Text
    //
    scoreText = game.add.text(16, 16, 'Weight Gain: 0kg', { fontSize: '32px', fill: '#00FF00' });
    gameTimeText = game.add.text(300, 16, 'Time: 0', { fontSize: '32px', fill: '#00FF00' });

    //
    // Kontoller
    //
    //cursors = game.input.keyboard.createCursorKeys();
    jumpButton = game.input.keyboard.addKey(Phaser.Keyboard.SPACEBAR);

    //
    // Sound
    //
    sound = game.add.audio('dmg');
    
}

function update () {

    // Kollision mellan objekt
    game.physics.arcade.collide(foodItems, layer);
    game.physics.arcade.collide(sumos, layer);
    game.physics.arcade.collide(enemy, layer);

    //Kollision mellan spelare och layer
    game.physics.arcade.collide(player, layer);

    // Koll om splare tar ett foodItem
    game.physics.arcade.overlap(player, foodItems, collectFood, null, this);
    //game.physics.arcade.collide(player, foodItems, collectFood, null, this);

    // Mata sumo
    game.physics.arcade.overlap(player, sumos, feedTheSumo, null, this);

    // tappa maten vid krock med fiende
    game.physics.arcade.overlap(player, enemy, droppFood, null, this);

    // hanterar input
    inputHandler(player);

    // Enemy
    moveEnemy(enemy, 1, 1);

    // Time
    gameTimeDisplay();
}

// 
// ======================Functions======================
//

function createPlayer()
{
    // Skapar spelare i scenen
    player = game.add.sprite(300, game.world.height - 180, 'player');

    //game.physics.arcade.enable(player);
    game.physics.enable(player, Phaser.Physics.ARCADE);

    // Spelarens egenskaper
    player.body.bounce.y = 0.1;
    player.body.gravity.y = 800;
    player.body.collideWorldBounds = true;
    player.body.setSize(20, 32, 5, 16);

    // Spelarens animationer (Bara i början?)
    player.animations.add('left', [0, 1, 2, 3], 10, true);
    player.animations.add('right', [5, 6, 7, 7], 10, true);
}

function createSumo(sumos)
{
    var sumo = sumos.create(400, game.world.height - 145, 'sumoGreen');
    game.physics.enable(sumo, Phaser.Physics.ARCADE);
    sumo.body.gravity.y = 800;
}

function createEnemy()
{
    enemy = game.add.sprite(300, game.world.height - 130, 'baddie');
    game.physics.enable(enemy, Phaser.Physics.ARCADE);
    enemy.enableBody = true;
    enemy.body.gravity.y = 800;
}

function createFoodItem(foodItems, x, y, bool)
{
    var food = foodItems.create(x, game.world.height - y, 'food');
    game.physics.enable(food, Phaser.Physics.ARCADE);

    if(bool) 
    {
        food.body.bounce.y = 0.3;
        food.body.gravity.y = 800;
        food.body.velocity.y = -180
    }
 
}

// Behöver player om man ska ha flera spelare
function inputHandler(player)
{
    // Nollställer rörelse
    player.body.velocity.x = 0;
    // TODO
    //player.body.drag.setTo(false, true);

    // Vänster / höger
    if (cursors.left.isDown)
    {
        //  Vänster
        player.body.velocity.x = -150;
        player.animations.play('left');
    }
    else if (cursors.right.isDown)
    {
        player.body.velocity.x = 150;
        player.animations.play('right');
    }
    else
    {
        player.animations.stop();
        player.frame = 4;
    }

    // Hoppa
    if (jumpButton.isDown && player.body.onFloor())
    {
        player.body.velocity.y = -500;
    }
}

function gameTimeDisplay()
{
    // TODO
    // Bara hela sekunder bör ändras
    gameTime = Math.round((game.time.now - game.time._started)/1000);
    gameTimeText.text = 'Time: ' + gameTime;
}

function collectFood(player, food)
{
    food.kill();
    hasFoodItem = true;
    console.log('Collected food, , hasFoodItem =' + hasFoodItem);
}

function feedTheSumo(player, sumo)
{
    if(hasFoodItem)
    {
        score += 5;
        scoreText.text = 'Weight Gain: ' + score + 'kg';
        hasFoodItem = false;
        console.log('feed sumo, hasFoodItem = ' + hasFoodItem);
        // TODO
        starvingSumo();
        //console.log(startTime);
    }

}

function starvingSumo()
{
 //console.log('time elapsed:' + game.time.time);
}

function droppFood(player, enemy)
{
    if(hasFoodItem)
    {
        hasFoodItem = false;
        console.log('Droped the food, , hasFoodItem =' + hasFoodItem);
        createFoodItem(foodItems, 350, 125, true);
        sound.play('');
    }
}

function moveEnemy(enemy, x1, x2)
{
    /*var tween = game.add.tween(enemy).to({ x: 400}, 6000, Phaser.Easing.Linear.None).to({ x: 300}, 6000, Phaser.Easing.Linear.None).loop().start();*/
    //if(enemy.body.x > x1)
    var tween = game.add.tween(enemy).to({x:400}, 4000, Phaser.Easing.Linear.None, null, false, 0, 0, true);
    tween.loop()
    tween.start();
}


</script>

</body>
</html>